<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianificatore di Dieta con IA</title>
    <!-- Carica Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un colore di sfondo più morbido */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Barra di navigazione -->
    <header class="bg-emerald-600 shadow-md py-4">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="#" class="text-white text-3xl font-extrabold tracking-tight">
                Dieta<span class="text-emerald-200">AI</span>
            </a>
            <nav>
                <a href="#input-section" class="text-white hover:text-emerald-200 transition-colors duration-200">Inizia</a>
            </nav>
        </div>
    </header>

    <!-- Contenuto principale dell'app -->
    <main class="flex-grow p-6 sm:p-10 flex justify-center items-start">
        <div class="w-full max-w-3xl">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-gray-800 mb-4 tracking-tight">
                Pianificatore di Dieta con <span class="text-emerald-500">IA</span>
            </h1>
            <p class="text-lg text-center text-gray-600 mb-10">
                Inserisci i tuoi dati e lascia che la nostra IA crei il piano alimentare perfetto per te.
            </p>

            <!-- Sezione del modulo di input -->
            <div id="input-section" class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 mb-6">
                <div class="grid sm:grid-cols-2 gap-6">
                    <div class="sm:col-span-2">
                        <label for="goal" class="block text-gray-700 font-medium mb-1">Il tuo obiettivo (es. perdere peso, aumentare massa muscolare)</label>
                        <input type="text" id="goal" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800" placeholder="Perdere 5 kg in un mese">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="dietaryRestrictions" class="block text-gray-700 font-medium mb-1">Restrizioni alimentari (es. vegano, vegetariano, keto)</label>
                        <input type="text" id="dietaryRestrictions" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800" placeholder="Vegetariano">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="allergies" class="block text-gray-700 font-medium mb-1">Allergie (es. lattosio, glutine, noci)</label>
                        <input type="text" id="allergies" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800" placeholder="Senza glutine">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="preferences" class="block text-gray-700 font-medium mb-1">Alimenti preferiti o da evitare</label>
                        <textarea id="preferences" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800 h-24 resize-none" placeholder="Adoro il salmone, non mi piacciono i broccoli"></textarea>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="healthConditions" class="block text-gray-700 font-medium mb-1">Condizioni di salute rilevanti</label>
                        <textarea id="healthConditions" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800 h-24 resize-none" placeholder="Diabete, pressione alta, etc."></textarea>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="generateBtn" class="w-full py-3 px-6 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300">
                        Genera Piano Alimentare
                    </button>
                </div>
            </div>

            <!-- Sezione per visualizzare il risultato (inizialmente nascosta) -->
            <div id="result-container" class="hidden">
                <!-- Il contenuto verrà inserito qui da JavaScript -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-10">
        <div class="container mx-auto px-6 text-center text-sm text-gray-400">
            &copy; 2024 DietaAI. Tutti i diritti riservati.
        </div>
    </footer>

    <!-- Libreria per convertire Markdown in HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const goalInput = document.getElementById('goal');
        const dietaryRestrictionsInput = document.getElementById('dietaryRestrictions');
        const allergiesInput = document.getElementById('allergies');
        const preferencesInput = document.getElementById('preferences');
        const healthConditionsInput = document.getElementById('healthConditions');
        const resultContainer = document.getElementById('result-container');
        const inputSection = document.getElementById('input-section');

        const WORKER_URL = "https://myaiapi.qy284hmxgx.workers.dev";
        const MAX_RETRIES = 3;
        const INITIAL_BACKOFF_DELAY = 1000;

        async function makeApiCall(prompt, userData, retries = 0) {
            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, userData })
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < MAX_RETRIES) {
                        const delay = INITIAL_BACKOFF_DELAY * Math.pow(2, retries);
                        console.warn(`Errore 429 (troppe richieste). Riprovo in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        return makeApiCall(prompt, userData, retries + 1);
                    }
                    throw new Error(`Errore di connessione al server: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Risposta non valida.');
                }
            } catch (e) {
                console.error("Errore nella richiesta:", e);
                throw e;
            }
        }

        generateBtn.addEventListener('click', async () => {
            const userData = {
                goal: goalInput.value,
                dietaryRestrictions: dietaryRestrictionsInput.value,
                allergies: allergiesInput.value,
                preferences: preferencesInput.value,
                healthConditions: healthConditionsInput.value
            };

            generateBtn.disabled = true;
            generateBtn.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generazione in corso...
                </div>
            `;
            resultContainer.innerHTML = '';
            resultContainer.classList.add('hidden');
            inputSection.classList.add('hidden');

            const prompt = `
                Genera un piano alimentare settimanale personalizzato in italiano, in formato Markdown. Il piano deve essere ottimizzato per le seguenti informazioni:

                - Obiettivo: ${userData.goal}
                - Restrizioni alimentari: ${userData.dietaryRestrictions}
                - Allergie: ${userData.allergies}
                - Preferenze alimentari: ${userData.preferences}
                - Condizioni di salute (se presenti): ${userData.healthConditions}

                Il piano deve includere colazione, pranzo, cena e uno spuntino per ogni giorno della settimana. Fornisci anche una breve motivazione per le scelte alimentari fatte in base agli obiettivi specifici.
            `;
            
            try {
                const generatedText = await makeApiCall(prompt, userData);
                displayDietPlan(generatedText, userData);
            } catch (e) {
                displayError('Si è verificato un errore. Riprova più tardi.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Genera Piano Alimentare';
            }
        });

        // Funzione per visualizzare il piano alimentare e il profilo utente
        function displayDietPlan(plan, userData) {
            resultContainer.classList.remove('hidden');
            const markdownToHtml = marked.parse(plan); // Converte il Markdown in HTML
            resultContainer.innerHTML = `
                <!-- Bottone per chiudere -->
                <button id="closeBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full mb-6 transition-colors duration-200">
                    &larr; Chiudi
                </button>

                <!-- Contenitore del profilo e del piano -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Il mio profilo</h2>
                    <ul class="list-none p-0 m-0 text-gray-700">
                        <li><strong>Obiettivo:</strong> ${userData.goal}</li>
                        <li><strong>Restrizioni:</strong> ${userData.dietaryRestrictions}</li>
                        <li><strong>Allergie:</strong> ${userData.allergies}</li>
                        <li><strong>Preferenze:</strong> ${userData.preferences}</li>
                        <li><strong>Condizioni:</strong> ${userData.healthConditions}</li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Il tuo piano alimentare personalizzato</h2>
                    <div class="prose max-w-none text-gray-700 leading-relaxed">${markdownToHtml}</div>
                </div>

                <!-- Sezione per fare domande all'IA -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Fai una domanda all'IA</h3>
                    <textarea id="questionInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 bg-white text-gray-800 h-24 resize-none mb-4" placeholder="Ad esempio: 'Posso sostituire il riso con la quinoa?'"></textarea>
                    <button id="askBtn" class="w-full py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Chiedi
                    </button>
                    <div id="answer-container" class="mt-4"></div>
                </div>
            `;
            
            document.getElementById('closeBtn').addEventListener('click', () => {
                inputSection.classList.remove('hidden');
                resultContainer.classList.add('hidden');
            });

            document.getElementById('askBtn').addEventListener('click', async () => {
                const questionInput = document.getElementById('questionInput');
                const answerContainer = document.getElementById('answer-container');
                const askBtn = document.getElementById('askBtn');
                
                const question = questionInput.value;
                if (!question) return;

                askBtn.disabled = true;
                askBtn.innerHTML = `
                    <div class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Rispondo...
                    </div>
                `;
                answerContainer.innerHTML = '';

                const fullPrompt = `Rispondi a questa domanda sul piano alimentare: "${question}". Considera che il piano è stato generato in base a questi dati dell'utente: Obiettivo: ${userData.goal}, Restrizioni: ${userData.dietaryRestrictions}, Allergie: ${userData.allergies}, Preferenze: ${userData.preferences}, Condizioni: ${userData.healthConditions}. La tua risposta deve essere breve e diretta.`;
                
                try {
                    const answer = await makeApiCall(fullPrompt, userData);
                    answerContainer.innerHTML = `<div class="bg-gray-100 p-4 rounded-lg text-gray-800">${marked.parse(answer)}</div>`;
                } catch (e) {
                    answerContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">Si è verificato un errore. Riprova.</div>`;
                    console.error("Errore nella richiesta:", e);
                } finally {
                    askBtn.disabled = false;
                    askBtn.innerHTML = 'Chiedi';
                }
            });
        }

        // Funzione per visualizzare un errore
        function displayError(message) {
            resultContainer.classList.remove('hidden');
            resultContainer.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <span class="block sm:inline">${message}</span>
                </div>
            `;
        }
    </script>
</body>
</html>

